<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Wallet Dashboard</title>
<style>
  body { font-family: Arial; padding: 20px; }
  #dashboard { display:none; }
  input { margin:5px 0; padding:5px; width:200px; }
  button { padding:5px 10px; margin-top:5px; cursor:pointer; }
  hr { margin:20px 0; }
</style>
</head>
<body>

<h2 id="title">Login</h2>

<button id="loginBtn">Login with Google</button>
<button id="logoutBtn" style="display:none;">Logout</button>

<hr>

<div id="dashboard">
  <h3>User Info</h3>
  <p><b>Email:</b> <span id="email"></span></p>
  <p><b>Account No:</b> <span id="account"></span></p>
  <p><b>Balance:</b> $<span id="balance"></span></p>

  <hr>
  <h3>Send Money</h3>
  <input id="toAccount" placeholder="Receiver Account Number"><br>
  <input id="amount" type="number" placeholder="Amount"><br>
  <button id="sendBtn">Send</button>
  <p id="msg"></p>

  <hr>
  <h3>Add Balance (Demo)</h3>
  <input id="addAmount" type="number" placeholder="Amount"><br>
  <button id="addBtn">Add Balance</button>
</div>

<script type="module">
  // ðŸ”¹ Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // ðŸ”¹ Firebase config (à¦¤à§‹à¦®à¦¾à¦° à¦¦à§‡à§Ÿà¦¾)
  const firebaseConfig = {
    apiKey: "AIzaSyDjEgk5EHgQD5HQJxEvHOzFwVyr9ZLEZBY",
    authDomain: "verifyprojectss.firebaseapp.com",
    projectId: "verifyprojectss",
    storageBucket: "verifyprojectss.appspot.com",
    messagingSenderId: "979191477358",
    appId: "1:979191477358:web:2f5176ea9174579118a27f"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db = getFirestore(app);

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const dashboard = document.getElementById("dashboard");

  function generateAccount() {
    return "AC" + Math.floor(100000 + Math.random()*900000);
  }

  async function showDashboard(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    const data = snap.data();
    document.getElementById("email").innerText = data.email;
    document.getElementById("account").innerText = data.account;
    document.getElementById("balance").innerText = data.balance;

    dashboard.style.display = "block";
    loginBtn.style.display = "none";
    logoutBtn.style.display = "block";
  }

  // ðŸ”¹ Login
  loginBtn.onclick = async () => {
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);

      if(!snap.exists()) {
        await setDoc(ref, {
          email: user.email,
          account: generateAccount(),
          balance: 100
        });
      }

      showDashboard(user.uid);
    } catch(e) {
      alert(e.message);
      console.log(e);
    }
  };

  // ðŸ”¹ Logout
  logoutBtn.onclick = () => signOut(auth);

  // ðŸ”¹ Auth state
  onAuthStateChanged(auth, user => {
    if(user) showDashboard(user.uid);
    else {
      dashboard.style.display = "none";
      loginBtn.style.display = "block";
      logoutBtn.style.display = "none";
    }
  });

  // ðŸ”¹ Send Money
  document.getElementById("sendBtn").onclick = async () => {
    const toAcc = document.getElementById("toAccount").value;
    const amount = Number(document.getElementById("amount").value);
    const msg = document.getElementById("msg");
    const sender = auth.currentUser;
    if(!sender) return;

    const senderRef = doc(db, "users", sender.uid);
    const senderSnap = await getDoc(senderRef);
    const senderData = senderSnap.data();

    if(senderData.balance < amount) {
      msg.innerText = "âŒ Insufficient balance";
      return;
    }

    const q = query(collection(db, "users"), where("account","==",toAcc));
    const res = await getDocs(q);

    if(res.empty) {
      msg.innerText = "âŒ Account not found";
      return;
    }

    const receiverDoc = res.docs[0];
    const receiverRef = receiverDoc.ref;
    const receiverData = receiverDoc.data();

    await updateDoc(senderRef,{ balance: senderData.balance - amount });
    await updateDoc(receiverRef,{ balance: receiverData.balance + amount });

    msg.innerText = "âœ… Money sent successfully";
    showDashboard(sender.uid); // refresh balance
  };

  // ðŸ”¹ Add Balance (Demo)
  document.getElementById("addBtn").onclick = async () => {
    const amount = Number(document.getElementById("addAmount").value);
    const user = auth.currentUser;
    if(!user || amount <=0) return;

    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);
    const data = snap.data();

    await updateDoc(ref, { balance: data.balance + amount });
    alert("âœ… Balance Added");
    showDashboard(user.uid);
  };

</script>

</body>
</html>
