<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<style>
body { font-family: Arial; padding: 20px; max-width: 500px; margin: auto; }
h2,h3 { margin: 10px 0; }
input, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
button { cursor: pointer; }
.balance { color: green; font-weight: bold; font-size: 18px; }
#sendBtn { background-color: #23487f; color: white; border: none; }
#logoutBtn { background-color: #ff4b4b; color: white; border: none; }
</style>
</head>
<body>

<h2>Welcome, <span id="userName"></span></h2>
<h3>Balance: <span class="balance" id="userBalance">0</span> SC</h3>

<h3>Send Money</h3>
<input type="email" id="receiverEmail" placeholder="Receiver Email">
<input type="number" id="amount" placeholder="Amount">
<button id="sendBtn">Send</button>
<button id="logoutBtn">Logout</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ðŸ”¹ Firebase Config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

// ðŸ”¹ Check login
onAuthStateChanged(auth, async (user) => {
  if(!user) {
    window.location.href = "index.html";
    return;
  }

  currentUser = user;
  document.getElementById("userName").innerText = user.displayName;

  // ðŸ”¹ Load balance & real-time update
  const senderRef = doc(db, "users", user.uid);
  onSnapshot(senderRef, (docSnap) => {
    if(docSnap.exists()){
      document.getElementById("userBalance").innerText = docSnap.data().balance;
    }
  });
});

// ðŸ”¹ Send Money
document.getElementById("sendBtn").addEventListener("click", async () => {
  const receiverEmail = document.getElementById("receiverEmail").value.trim();
  const amount = parseFloat(document.getElementById("amount").value);

  if(!receiverEmail || !amount) return alert("Fill all fields");

  try {
    // ðŸ”¹ Find receiver
    const q = query(collection(db, "users"), where("email", "==", receiverEmail));
    const querySnap = await getDocs(q);
    if(querySnap.empty) return alert("Receiver not found");

    const receiverDoc = querySnap.docs[0];
    const receiverRef = doc(db, "users", receiverDoc.id);

    // ðŸ”¹ Sender balance
    const senderRef = doc(db, "users", currentUser.uid);
    const senderSnap = await getDoc(senderRef);

    if(senderSnap.data().balance < amount) return alert("Insufficient Balance");

    // ðŸ”¹ Update balances
    await updateDoc(senderRef, { balance: senderSnap.data().balance - amount });
    await updateDoc(receiverRef, { balance: receiverDoc.data().balance + amount });

    alert("Money sent successfully!");
    document.getElementById("receiverEmail").value = "";
    document.getElementById("amount").value = "";

  } catch (e) {
    alert("Error: " + e.message);
  }
});

// ðŸ”¹ Logout
document.getElementById("logoutBtn").addEventListener("click", () => signOut(auth));
</script>

</body>
</html>
