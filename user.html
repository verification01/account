<!DOCTYPE html>
<html>
<head>
  <title>User Wallet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body style="text-align:center;font-family:Arial">

<h2 id="name">User</h2>
<p>Account ID: <b id="accId"></b></p>
<h3 id="balance">Balance: --</h3>

<hr>

<input id="to" placeholder="Receiver Account ID"><br><br>
<input id="amount" type="number" placeholder="Amount"><br><br>
<button onclick="send()">Send</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, onSnapshot, runTransaction, collection, query, where, getDocs } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDjEgk5EHgQD5HQJxEvHOzFwVyr9ZLEZBY",
  authDomain: "verifyprojectss.firebaseapp.com",
  projectId: "verifyprojectss"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let myUid;
let myAccountId;

// login check
onAuthStateChanged(auth,(user)=>{
  if(!user){
    window.location.href="index.html";
    return;
  }

  myUid = user.uid;
  const ref = doc(db,"users",myUid);

  onSnapshot(ref,(snap)=>{
    const d = snap.data();
    document.getElementById("name").innerText = d.name;
    document.getElementById("accId").innerText = d.accountId;
    document.getElementById("balance").innerText = "Balance: "+d.balance;
    myAccountId = d.accountId;
  });
});

async function send(){
  const toId = document.getElementById("to").value;
  const amount = Number(document.getElementById("amount").value);

  if(amount<=0) return alert("Invalid amount");

  const q = query(collection(db,"users"), where("accountId","==",toId));
  const snap = await getDocs(q);

  if(snap.empty) return alert("Receiver not found");

  const receiverDoc = snap.docs[0].ref;
  const senderDoc = doc(db,"users",myUid);

  try{
    await runTransaction(db, async(tx)=>{
      const s = await tx.get(senderDoc);
      const r = await tx.get(receiverDoc);

      if(s.data().balance < amount) throw "Not enough balance";

      tx.update(senderDoc,{balance:s.data().balance-amount});
      tx.update(receiverDoc,{balance:r.data().balance+amount});
    });

    alert("Transfer successful âœ…");
  }catch(e){
    alert(e);
  }
}

window.send = send;
</script>

</body>
</html>
